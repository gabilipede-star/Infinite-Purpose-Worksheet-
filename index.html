<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const textareas = document.querySelectorAll('textarea');
    textareas.forEach(textarea => {
        textarea.addEventListener('input', autoExpand);
        autoExpand.call(textarea);
    });
    loadProgress();
    updateProgress();
});

function autoExpand() {
    this.style.height = 'auto';
    this.style.height = this.scrollHeight + 'px';
}

// Save & Load Progress
function saveProgress() {
    const data = {};
    document.querySelectorAll('textarea, input[type="text"]').forEach(el => {
        if (el.id) data[el.id] = el.value;
    });
    localStorage.setItem('infinitePurposeWorksheet', JSON.stringify(data));
    alert('Progress saved!');
}
function loadProgress() {
    const saved = localStorage.getItem('infinitePurposeWorksheet');
    if (!saved) return;
    const data = JSON.parse(saved);
    Object.entries(data).forEach(([id, val]) => {
        const el = document.getElementById(id);
        if (el) {
            el.value = val;
            if (el.tagName === 'TEXTAREA') autoExpand.call(el);
        }
    });
}
function clearForm() {
    if (!confirm('Clear all responses?')) return;
    document.querySelectorAll('textarea, input[type="text"]').forEach(el => {
        el.value = '';
        el.style.height = '80px';
    });
    localStorage.removeItem('infinitePurposeWorksheet');
    updateProgress();
}
function updateProgress() {
    const fields = document.querySelectorAll('textarea, input[type="text"]');
    const filled = Array.from(fields).filter(f => f.value.trim() !== '').length;
    document.getElementById('progressBar').style.width = (filled / fields.length * 100) + '%';
}

// ðŸ§¾ Download Full-Length PDF
async function generatePDF() {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({ unit: 'pt', format: 'a4' });
    const element = document.getElementById('worksheetContent');

    // Expand all textareas before rendering
    const textareas = element.querySelectorAll('textarea');
    textareas.forEach(ta => {
        ta.style.height = 'auto';
        ta.style.height = ta.scrollHeight + 'px';
        ta.style.overflow = 'visible';
    });

    // Hide control buttons
    const buttons = document.querySelector('.action-buttons');
    buttons.style.display = 'none';

    // Give DOM time to update
    await new Promise(r => setTimeout(r, 300));

    // Use html2canvas to render all content into a high-res image
    const canvas = await html2canvas(element, {
        scale: 2,
        useCORS: true,
        windowWidth: document.documentElement.scrollWidth,
        windowHeight: document.documentElement.scrollHeight
    });

    const imgData = canvas.toDataURL('image/png');
    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();
    const imgHeight = (canvas.height * pageWidth) / canvas.width;

    let yPos = 0;
    let heightLeft = imgHeight;

    pdf.addImage(imgData, 'PNG', 0, yPos, pageWidth, imgHeight);
    heightLeft -= pageHeight;

    while (heightLeft > 0) {
        yPos = heightLeft - imgHeight;
        pdf.addPage();
        pdf.addImage(imgData, 'PNG', 0, yPos, pageWidth, imgHeight);
        heightLeft -= pageHeight;
    }

    buttons.style.display = 'flex';
    const date = new Date().toISOString().split('T')[0];
    pdf.save(`infinite-purpose-${date}.pdf`);
}
</script>
